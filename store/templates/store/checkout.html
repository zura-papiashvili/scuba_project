{% extends "base.html" %}

{% block content %}
    <div class="container">
        <h1 class="mt-5">Checkout</h1>

        <div class="checkout-details">
            <h2>Your Cart</h2>
            <ul>
                {% for item in cart_items %}
                    <li>{{ item.product.name }} - {{ item.quantity }} x ${{ item.product.price }}</li>
                {% endfor %}
            </ul>
            <h3>Total Price: ${{ total_price }}</h3>
        </div>

        <h2>Payment Options</h2>
        <form method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="payment-option">Choose a payment method:</label>
                <select class="form-control" id="payment-option" name="payment_method" onchange="togglePaymentMethod()">
                    <option value="stripe">Pay Now (Stripe)</option>
                    <option value="cash">Pay Later (Cash on Delivery)</option>
                </select>
            </div>

            <div id="stripe-payment" class="payment-method" style="display: block;">
                <h3>Pay with Credit Card (Stripe)</h3>
                <div id="card-element"></div>
                <div id="card-errors" role="alert"></div>
            </div>

            <div id="cash-payment" class="payment-method" style="display: none;">
                <h3>Pay with Cash on Delivery</h3>
                <p>You can pay for your order in cash when the items are delivered to you.</p>
            </div>

            <button type="submit" id="submit" class="btn btn-primary mt-3">Proceed</button>
        </form>

        <script src="https://js.stripe.com/v3/"></script>
        <script>
            var stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
            var elements = stripe.elements();
            var card = elements.create("card");
            card.mount("#card-element");

            var form = document.getElementById("payment-form");
            form.addEventListener("submit", function(event) {
                event.preventDefault();

                stripe.confirmCardPayment("{{ client_secret }}", {
                    payment_method: {
                        card: card,
                        billing_details: {
                            name: "{{ user.username }}",
                        },
                    },
                }).then(function(result) {
                    if (result.error) {
                        document.getElementById("card-errors").textContent = result.error.message;
                    } else {
                        if (result.paymentIntent.status === "succeeded") {
                            // Now passing order.id correctly
                            window.location.href = "{% url 'order_confirmation' order_id=order.id %}";
                        }
                    }
                });
            });
</script>


    </div>
{% endblock %}
