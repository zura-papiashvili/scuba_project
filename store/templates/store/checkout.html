<!-- checkout.html -->
{% extends "base.html" %}

{% block content %}
    <h1>Checkout</h1>
    <div class="checkout-details">
        <h2>Your Cart</h2>
        <ul>
            {% for item in cart_items %}
                <li>{{ item.product.name }} - {{ item.quantity }} x ${{ item.product.price }}</li>
            {% endfor %}
        </ul>
        <h3>Total Price: ${{ total_price }}</h3>
    </div>

    <h2>Payment</h2>
    <form id="payment-form" method="post">
        {% csrf_token %}
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
        <button id="submit">Pay</button>
    </form>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        var stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
        var elements = stripe.elements();
        var card = elements.create("card");
        card.mount("#card-element");

        var form = document.getElementById("payment-form");
        form.addEventListener("submit", function(event) {
            event.preventDefault();

            stripe.confirmCardPayment("{{ client_secret }}", {
                payment_method: {
                    card: card,
                    billing_details: {
                        name: "{{ user.username }}",
                    },
                },
            }).then(function(result) {
                if (result.error) {
                    document.getElementById("card-errors").textContent = result.error.message;
                } else {
                    if (result.paymentIntent.status === "succeeded") {
                        window.location.href = "{% url 'store:order_confirmation' order.id %}";
                    }
                }
            });
        });
    </script>
{% endblock %}
